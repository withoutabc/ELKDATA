input {
  file {
    path => "/home/withoutabc/elk/elk_data/log/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
  }
}

filter {
  if "client_ip" in [message] {
    grok {
      match => { "message" => "timestamp:%{TIMESTAMP_ISO8601:timestamp},status_code:%{NUMBER:status_code},client_ip:%{IP:client_ip},latency:%{NUMBER:latency_value}%{DATA:latency_unit},method:%{WORD:method},path:%{URIPATH:path}" }
    }
    date {
        match => [ "timestamp", "yyyy-MM-dd HH:mm:ss" ]
        target => "@timestamp"
    }
    mutate {
      add_field => {
        "index_name" => "visit"
      }
    }
  } else if "country" in [message] {
    grok {
      match => { "message" => "{\"level\":\"%{WORD:level}\",\"msg\":\"country:%{WORD:country},region:%{WORD:region},city:%{WORD:city}\",\"time\":\"%{TIMESTAMP_ISO8601:time}\"}" }
    }

    mutate {
      add_field => {
        "index_name" => "ip"
      }
    }
  } else {
    drop {}
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{index_name}"
  }
}
